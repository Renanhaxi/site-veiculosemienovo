<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Marcelo Macedo ‚Ä¢ Consultor Volkswagen ‚Ä¢ Vega Automotores</title>
<meta name="description" content="O seu Volkswagen Zero, comprado de forma mais inteligente. Consultoria exclusiva na Vega Automotores, Bel√©m/PA."/>
<link rel="icon" href="data:,">
<style>
  /* Tema Claro e Cores VW */
  :root{--bg:#f8fafc;--card:#ffffff;--line:rgba(0,0,0,.10);--muted:#64748b;--text:#1e293b;--brand-vw:#002975;--accent-vw:#1D90F5;--wa:#25D366;--shadow:0 4px 12px rgba(0,0,0,.08);}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{max-width:1200px;margin:0 auto;padding:0 14px}
  header{position:sticky;top:0;z-index:50;background:var(--card);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);box-shadow:var(--shadow);}
  h1{font-size:clamp(20px,3vw,26px);margin:10px 0;color:var(--brand-vw)}
  .muted{color:var(--muted)}
  .nav{display:flex;gap:10px;align-items:center}
  /* Estilos para bot√µes gerais */
  .btn,.chip{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--text);text-decoration:none;cursor:pointer;font-weight:600;transition:all .2s;box-shadow:var(--shadow)}
  .btn:hover{background:#f1f5f9;border-color:var(--brand-vw)}
  .btn.primary{background:var(--accent-vw);color:#fff;border-color:var(--accent-vw);font-weight:800;box-shadow:0 4px 10px rgba(29, 144, 245, 0.4);}
  .btn.wa{background:var(--wa);color:#031b11;border-color:var(--wa);font-weight:800}
  .btn.wa:hover{filter:brightness(1.1)}

  /* NOVO ESTILO: √çCONE DE LOGIN */
  .btn.icon-only {
    padding: 8px; /* Reduz o padding para um √≠cone */
    width: 40px; 
    height: 40px; 
  }
  .btn.icon-only svg {
    margin: 0;
  }
  
  /* A classe .grid geral permanece a mesma */
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin:20px 0 30px}
  /* Adicionando classe espec√≠fica para o Cat√°logo e filtros de responsividade */
  .grid-catalogo { grid-template-columns: repeat(3, 1fr); }
  @media(max-width:980px){
    .grid{grid-template-columns:repeat(2,1fr)}
    .grid-catalogo { grid-template-columns: repeat(2, 1fr); }
  }
  @media(max-width:640px){
    .grid{grid-template-columns:1fr}
    .grid-catalogo { grid-template-columns: 1fr; }
  }

  .card{border:1px solid var(--line);border-radius:16px;overflow:hidden;background:var(--card);box-shadow:var(--shadow);transition:transform .2s}
  .card:hover{transform:translateY(-3px);}
  .thumb{aspect-ratio:16/10;background:var(--brand-vw);position:relative}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .pad{padding:16px}
  .title{font-weight:800;font-size:18px;margin:2px 0;color:var(--brand-vw)}
  .price{font-size:24px;font-weight:900;margin:8px 0;color:var(--accent-vw)}
  .filters{display:grid;grid-template-columns:1fr repeat(4,140px);gap:10px;margin-top:20px}
  
  /* AJUSTE MOBILE: FILTROS */
  @media(max-width:768px){.filters{grid-template-columns:1fr 1fr;}}
  @media(max-width:480px){.filters{grid-template-columns:1fr;}}

  input,select,textarea{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--text);box-shadow:inset 0 1px 3px rgba(0,0,0,.06);width:100%;}
  textarea{resize:vertical;min-height:100px}
  
  .section-title{display:flex;align-items:center;justify-content:space-between;margin-top:40px}
  .pill{padding:4px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted);background:#f1f5f9}
  footer{border-top:1px solid var(--line);color:var(--muted);padding:20px;margin-top:40px}
  .hide{display:none}
  .hero{padding:40px 0;text-align:center;background:#e2e8f0;border-radius:16px;margin-top:20px}
  .dealer-info{display:grid;grid-template-columns:2fr 1fr;gap:30px;padding:30px 0;margin-top:20px;border-top:1px solid var(--line);text-align:left}
  @media(max-width:960px){.dealer-info{grid-template-columns:1fr}}
  .dealer-info h3{color:var(--brand-vw);margin-top:0}
  
  /* AJUSTE MOBILE: KPIS (Permite quebrar a linha se n√£o houver espa√ßo) */
  .kpi-container{display:flex;gap:15px;margin-top:10px; flex-wrap: wrap;} 
  
  .kpi div{font-size:24px;font-weight:900;color:var(--accent-vw)}
  .kpi span{font-size:12px;color:var(--muted)}
  .wa-float{position:fixed;bottom:20px;right:20px;z-index:100}

  /* AJUSTE MOBILE: HEADER (Empilha o logo e o texto se a tela for muito estreita) */
  @media(max-width: 480px) {
    header .wrap > a:first-child { 
        flex-direction: column; 
        align-items: flex-start;
        gap: 0;
    }
    header .wrap h1 {
        margin-top: 5px;
        font-size: 18px;
    }
    header .wrap a {
        align-items: center;
    }
  }

  /* Estilo da foto do vendedor */
  .vendedor-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 15px;
    border-radius: 16px;
    background: var(--card);
    box-shadow: var(--shadow);
    border: 1px solid var(--line);
  }
  .vendedor-photo {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 10px;
    border: 4px solid var(--accent-vw);
  }
  /* Estilo dos blocos de navega√ß√£o */
  .nav-block{
    display:flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 150px;
    padding: 20px;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: #f1f5f9;
    color: var(--brand-vw);
    transition: all .2s;
    text-decoration: none;
    font-weight: 700;
  }
  .nav-block:hover{
    background: var(--brand-vw);
    color: var(--card);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
  }

  /* Estilos espec√≠ficos do Login */
  .login-card { max-width: 400px; margin: 50px auto; padding: 30px; text-align: left; }
  .input-group { position: relative; margin-bottom: 15px; }
  .input-group input { width: 100%; }
  .input-group .toggle-password { 
    position: absolute; right: 10px; top: 50%; 
    transform: translateY(-50%); 
    cursor: pointer; 
    color: var(--muted);
    background: none;
    border: none;
    padding: 5px;
  }
  .login-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
  .login-actions .btn-google { background-color: #db4437; color: white; }
  .login-actions .btn-google:hover { background-color: #c33d32; }
  .login-actions .btn-google svg { margin-right: 8px; }
  
  /* ESTILOS DO NOVO MODAL DE ADMIN */
  .modal-backdrop {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.5); z-index: 1000;
    display: flex; justify-content: center; align-items: center;
    padding: 20px;
  }
  .modal-content {
    background: var(--card); border-radius: 16px; padding: 30px;
    max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;
    box-shadow: var(--shadow);
  }
  .modal-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px;
  }
  .modal-header button {
    background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted);
  }
  .form-group {
    margin-bottom: 15px;
  }
  .form-group label {
    display: block; font-size: 14px; color: var(--muted); margin-bottom: 5px;
  }
  .checkbox-group {
    display: flex; align-items: center; gap: 10px; margin-bottom: 15px;
  }
  .checkbox-group input[type="checkbox"] {
    width: auto; margin: 0; transform: scale(1.2);
  }
  
  /* LINHA DE SEGURAN√áA FOR√áADA: Garante que o modal esteja sempre invis√≠vel por padr√£o */
  #edit-modal.modal-backdrop {
    display: none !important; 
  }
  #edit-modal.modal-backdrop:not(.hide) {
    display: flex !important; /* For√ßa a exibi√ß√£o somente quando o JS remove a classe 'hide' */
  }
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;align-items:center;gap:15px;justify-content:space-between;padding:10px 0">
    <!-- HOME/T√çTULO -->
    <a href="#/portfolio" onclick="return route('portfolio')" style="display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit;">
      <svg width="40" height="40" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="48" fill="#fff" stroke="#002975" stroke-width="4"/><path d="M50 85L30 50L50 15L70 50L50 85Z" fill="#002975"/><path d="M50 80L35 50L50 20L65 50L50 80Z" fill="#fff"/><path d="M50 75L40 50L50 25L60 50L50 75Z" fill="#002975"/></svg>
      <div>
        <h1>Marcelo Macedo: Consultor Volkswagen</h1>
        <div class="muted" id="dealerLocation" style="font-size:13px">Vega Automotores ‚Ä¢ Bel√©m/PA</div>
      </div>
    </a>
    
    <nav class="nav">
      <!-- Mantido: Link prim√°rio para o Cat√°logo -->
      <a class="btn" href="#/catalogo" onclick="return route('catalogo')">Cat√°logo de Oportunidades</a>
      
      <!-- BOT√ÉO ICONE LOGIN/ADMIN -->
      <a class="btn icon-only admin-btn" id="loginAdminBtn" href="#/admin" onclick="return route('admin')">
        <!-- √çcone de Usu√°rio (substitui o texto) -->
        <svg id="login-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--brand-vw);"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
      </a>
    </nav>
  </div>
</header>

<main class="wrap">
  
  <!-- PAGE: PORTF√ìLIO / CONSULTORIA (DEFAULT) -->
  <section id="page-portfolio">
    <div class="hero">
      <h2 style="font-size:clamp(26px,4vw,40px);margin-bottom:8px;color:var(--brand-vw)">O seu Volkswagen Zero, comprado de forma mais inteligente.</h2>
      <p style="font-size:clamp(18px,2vw,22px);color:var(--muted);max-width:800px;margin:0 auto">Evite os erros caros da compra. Receba a consultoria exclusiva de Marcelo Macedo e a seguran√ßa da Vega Automotores.</p>
    </div>

    <!-- BLOCKS DE NAVEGA√á√ÉO R√ÅPIDA -->
    <div class="section-title">
      <h2 style="margin:16px 0;color:var(--brand-vw)">Aceda √†s Melhores Oportunidades</h2>
    </div>
    <!-- Aplicada a classe grid-catalogo para responsividade -->
    <div class="grid grid-catalogo">
      <a href="#/catalogo?filter=lancamentos" onclick="return route('catalogo', 'lancamentos')" class="nav-block">
        <div style="font-size:24px;margin-bottom:5px">üöÄ</div>
        Lan√ßamentos Exclusivos 2025
      </a>
      <a href="#/catalogo?filter=promocao" onclick="return route('catalogo', 'promocao')" class="nav-block">
        <div style="font-size:24px;margin-bottom:5px">üéÅ</div>
        Oportunidades com B√≥nus (Taxa Zero)
      </a>
      <a href="#/catalogo?filter=modelos" onclick="return route('catalogo', 'modelos')" class="nav-block">
        <div style="font-size:24px;margin-bottom:5px">SUV, Hatch, Sedan</div>
        Explore Todos os Modelos VW
      </a>
    </div>

    <!-- JORNADA DE CONSULTORIA -->
    <div class="section-title">
        <h2 style="margin:16px 0;color:var(--brand-vw)">4 Etapas para a Certeza da Compra</h2>
    </div>
    <div class="grid" style="grid-template-columns:repeat(4,1fr)">
      <div class="card pad" style="text-align:center">
        <div style="font-size:36px;font-weight:900;color:var(--accent-vw)">1.</div>
        <h3 style="margin:5px 0 10px">O Diagn√≥stico Inteligente</h3>
        <p class="muted">Antes de qualquer pre√ßo, alinho o seu desejo com as reais promo√ß√µes de f√°brica. Evito as armadilhas do mercado e garanto acesso √†s melhores condi√ß√µes feitas para si.</p>
      </div>
      <div class="card pad" style="text-align:center">
        <div style="font-size:36px;font-weight:900;color:var(--accent-vw)">2.</div>
        <h3 style="margin:5px 0 10px">O Valor Real do Seu Usado</h3>
        <p class="muted">Na Vega Automotores, maximizo o seu b√≥nus de troca, garantindo uma avalia√ß√£o 100% transparente para que o seu carro atual seja o seu maior investimento no VW Novo.</p>
      </div>
      <div class="card pad" style="text-align:center">
        <div style="font-size:36px;font-weight:900;color:var(--accent-vw)">3.</div>
        <h3 style="margin:5px 0 10px">Proposta de F√°brica: Sem Filtros</h3>
        <p class="muted">A proposta final chega diretamente a si no WhatsApp. Um clique √© tudo o que separa a simula√ß√£o da realidade. Transpar√™ncia garantida pelo seu consultor, antes de qualquer compromisso.</p>
      </div>
      <div class="card pad" style="text-align:center">
        <div style="font-size:36px;font-weight:900;color:var(--accent-vw)">4.</div>
        <h3 style="margin:5px 0 10px">A Certeza de um Novo Come√ßo</h3>
        <p class="muted">O momento da entrega √© a celebra√ß√£o da sua decis√£o inteligente. Com o selo de garantia Vega Automotores, est√° pronto para a estrada sem preocupa√ß√µes.</p>
      </div>
    </div>
    
    <!-- AUTHORIDADE -->
    <div class="dealer-info">
      <div id="concessionariaInfo">
        <h3>Vantagem Vega Automotores</h3>
        <p class="muted" id="bioConcessionaria">A Vega Automotores √© l√≠der em satisfa√ß√£o do cliente na regi√£o de Bel√©m. Ao lado da Volkswagen, garantimos a voc√™ n√£o apenas um carro zero, mas toda a seguran√ßa, garantia de f√°brica e servi√ßos de p√≥s-venda que s√≥ uma concession√°ria oficial pode oferecer.</p>
        <!-- KPIs da Concession√°ria -->
        <div class="kpi-container" id="concessionariaKpis">
          <div class="kpi"><div id="kpi-servicos">10+</div><span>Servi√ßos de P√≥s-Venda</span></div>
          <div class="kpi"><div id="kpi-garantia">5 Anos</div><span>Garantia de F√°brica</span></div>
        </div>
      </div>
      
      <!-- CARD DO VENDEDOR COM FOTO -->
      <div class="vendedor-card" id="vendedorCard">
        <img src="https://i.postimg.cc/BnNvBn0J/unnamed.jpg" alt="Marcelo Macedo - Consultor" class="vendedor-photo" id="vendedorPhoto" />
        <h3 style="margin-bottom:5px;margin-top:0">Marcelo Macedo</h3>
        <div class="muted" style="font-size:14px">Consultor Exclusivo VW</div>
        <p class="muted" id="bioVendedor" style="font-size:15px">A compra de um VW Zero n√£o deve ser um risco. Eu simplifico o processo, negoceio as condi√ß√µes de f√°brica por si e garanto que n√£o deixar√° dinheiro na mesa ao dar o seu usado como entrada.</p>
        <!-- KPIs do Vendedor -->
        <div class="kpi-container" id="vendedorKpis">
          <div class="kpi"><div id="kpi-clientes">1.500+</div><span>Clientes Satisfeitos</span></div>
          <div class="kpi"><div id="kpi-anos">10 Anos</div><span>De Experi√™ncia VW</span></div>
        </div>
      </div>
    </div>
    <div style="text-align:center;margin-top:40px">
        <a id="btnWA-bottom" class="btn wa" href="#" target="_blank" rel="noreferrer" style="font-size:1.1em">üí¨ Aperte o Cinto: Inicie a sua Compra Inteligente</a>
    </div>
  </section>

  <!-- PAGE: CAT√ÅLOGO DE OPORTUNIDADES -->
  <section id="page-catalogo" class="hide">
    <div class="section-title">
      <h2 style="margin:16px 0;color:var(--brand-vw)">Cat√°logo de Oportunidades Volkswagen</h2>
      <span class="pill"><span id="count">0</span> modelos Zero Km</span>
    </div>

    <div class="filters">
      <input id="q" type="search" placeholder="Buscar por T-Cross, Polo, Nivus‚Ä¶">
      <select id="fModel"><option value="">Modelo</option><option>Polo</option><option>Nivus</option><option>T-Cross</option><option>Virtus</option><option>Taos</option></select>
      <select id="fy"><option value="">Ano min.</option><option>2025</option><option>2024</option><option>2023</option></select>
      <select id="fCat"><option value="">Categoria</option><option>SUV</option><option>Sedan</option><option>Hatch</option></select>
      <select id="fs"><option value="recent">Mais recentes</option><option value="price-asc">Menor pre√ßo</option><option value="price-desc">Maior pre√ßo</option></select>
    </div>

    <div class="section-title">
        <h3 style="margin:16px 0;color:var(--brand-vw)">‚ú® Destaques da Semana</h3>
        <span class="pill">Negocia√ß√£o Exclusiva</span>
    </div>
    <!-- Aplicada a classe grid-catalogo e removido o style inline -->
    <div id="featured" class="grid grid-catalogo"></div>

    <div class="section-title">
        <h3 style="margin:16px 0;color:var(--brand-vw)">Estoque Completo</h3>
    </div>
    <!-- Aplicada a classe grid-catalogo e removido o style inline -->
    <div id="list" class="grid grid-catalogo"></div>
  </section>
  
  <!-- PAGE: DETALHE -->
  <section id="page-detalhe" class="hide">
    <div class="section-title">
        <h2 id="dt-title-main" style="margin:0;color:var(--brand-vw)"></h2>
        <!-- Bot√£o de voltar aprimorado -->
        <a href="#/catalogo" onclick="return route('catalogo')" class="btn soft">‚Üê Voltar para o Cat√°logo</a>
    </div>
    <div class="dealer-info" style="border:none;grid-template-columns:2fr 1fr;padding:10px 0;text-align:left">
        <div class="card" style="overflow:visible">
            <div class="thumb" id="dt-foto"></div>
            <div class="pad">
                <p id="dt-promo" style="font-weight:700;color:var(--accent-vw)"></p>
                <div class="meta" id="dt-meta"></div>
                <div class="price" id="dt-price"></div>
            </div>
        </div>
        <aside class="stack">
            <div class="card pad">
                <h3 style="margin-top:0;color:var(--brand-vw)">Simulador de Financiamento</h3>
                <div class="muted" style="font-size:12px">Preencha os campos para simular.</div>
                <div class="muted" style="font-size:12px">Entrada (R$)</div>
                <input id="s-entrada" type="number" placeholder="Ex: 30000" style="margin-bottom:10px">
                <div class="muted" style="font-size:12px">Meses</div>
                <input id="s-meses" type="number" placeholder="Ex: 48" style="margin-bottom:10px">
                <div class="muted" style="font-size:12px">Taxa a.m. (Previs√£o: 1.75%)</div>
                <input id="s-taxa" type="number" step="0.01" value="1.75" placeholder="1.75" style="margin-bottom:10px">
                <div class="muted" style="font-size:12px;margin-top:6px">Parcela estimada</div>
                <div id="s-parcela" class="price" style="font-size:20px;margin:5px 0 15px">R$ 0,00</div>
                <button id="btnProposta-dt" class="btn wa" style="width:100%">Enviar Proposta & Simula√ß√£o</button>
            </div>
            <div class="card pad">
                <h3 style="margin-top:0;color:var(--brand-vw)">Ficha R√°pida</h3>
                <ul id="dt-specs" class="muted" style="list-style-type:disc;margin:0;padding-left:20px;font-size:14px">
                    <li>Motor: 1.0 TSI</li>
                    <li>C√¢mbio: Autom√°tico</li>
                </ul>
            </div>
        </aside>
    </div>
  </section>

  <!-- PAGE: ADMIN -->
  <section id="page-admin" class="hide">
    <!-- Bot√£o de voltar aprimorado -->
    <a href="#/portfolio" onclick="return route('portfolio')" class="btn soft" style="margin-top:20px">‚Üê Voltar para a Home</a>

    <div id="box-login" class="login-card card">
      <h2 style="margin-top:0; color:var(--brand-vw)">√Årea Restrita | Consultor</h2>
      <div class="muted" style="font-size:13px">Use sua conta de consultor da Vega Automotores.</div>

      <div style="margin-top:20px">
        <div class="input-group">
          <input id="auth-email" placeholder="Seu E-mail" type="email" required>
        </div>
        <div class="input-group">
          <input id="auth-password" placeholder="Senha" type="password" required>
          <button class="toggle-password" onclick="togglePasswordVisibility()">
            <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
        </div>
      </div>
      
      <div class="login-actions">
        <button id="btn-login" class="btn primary">Entrar</button>
        <button id="btn-google-login" class="btn btn-google">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.52-.2-2.23H12v4.26h6.01c-.26 1.34-.96 2.47-1.97 3.23l3.37 2.6c2.09-1.94 3.35-4.78 3.35-8.08z" fill="#4285F4"/><path d="M12 23c3.27 0 6.13-1.08 8.18-2.94l-3.37-2.6c-.92.6-2.09.95-3.81.95-2.9 0-5.38-1.95-6.27-4.57H2.33v2.85C4.84 21.05 8.16 23 12 23z" fill="#34A853"/><path d="M5.73 13.98c-.14-.52-.23-1.07-.23-1.63s.09-1.11.23-1.63V7.95H2.33c-.42.84-.66 1.8-.66 2.85s.24 2.01.66 2.85l3.4 2.67-2.2z" fill="#FBBC05"/><path d="M12 5.06c1.77 0 3.32.61 4.54 1.79l2.87-2.87C17.72 2.92 15.06 2 12 2 8.16 2 4.84 3.95 2.33 6.91l3.4 2.67C6.62 7.01 9.10 5.06 12 5.06z" fill="#EA4335"/></svg>
          Google
        </button>
      </div>
    </div>

    <div id="box-app" class="hide">
      <div class="section-title" style="margin-top:6px;border-bottom:1px solid var(--line);padding-bottom:10px">
        <h2 id="dealerInfo">Carregando Informa√ß√µes...</h2>
        <div class="nav">
          <!-- Novo Carro chama o novo modal -->
          <button class="btn primary" id="newCar" onclick="openEditModal()">+ Novo Carro</button>
          <button class="btn soft" id="seed">Seed (6 Demos)</button>
          <button class="btn soft" id="refresh">Atualizar</button>
          <button class="btn soft" id="logout">Sair</button>
        </div>
      </div>
      <div id="listAdmin" class="stack" style="margin-top:10px"></div>
    </div>
  </section>

</main>

<div id="edit-modal" class="modal-backdrop hide">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title" style="margin:0;color:var(--brand-vw)">Novo Ve√≠culo</h3>
            <button onclick="closeEditModal()">√ó</button>
        </div>
        
        <form id="vehicle-form" onsubmit="return saveVehicle()">
            <input type="hidden" id="v-id">
            
            <div class="form-group">
                <label for="v-title">T√≠tulo Completo (Modelo, Vers√£o, Ano)</label>
                <input id="v-title" type="text" placeholder="Ex: VW T-Cross Comfortline 200 TSI" required>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                <div class="form-group">
                    <label for="v-price">Pre√ßo (R$)</label>
                    <input id="v-price" type="number" step="1000" placeholder="Ex: 135990" required>
                </div>
                <div class="form-group">
                    <label for="v-year">Ano/Modelo</label>
                    <input id="v-year" type="number" step="1" placeholder="Ex: 2025" required>
                </div>
            </div>
            
            <!-- PROMO√á√ÉO -->
            <h4 style="margin-top:20px;color:var(--muted)">Informa√ß√µes de Promo√ß√£o</h4>
            <div class="form-group">
                <label for="v-promo-tag">Tag de Destaque (Fica na Foto)</label>
                <input id="v-promo-tag" type="text" placeholder="Ex: Taxa Zero, Lan√ßamento 2025">
            </div>
            <div class="form-group">
                <label for="v-promo-text">Texto da Promo√ß√£o (Fica no Card)</label>
                <textarea id="v-promo-text" placeholder="Ex: B√≥nus de R$ 8.000 na troca do seu usado!"></textarea>
            </div>
            
            <!-- CHECKBOXES -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
                <div class="checkbox-group">
                    <input type="checkbox" id="v-destaque">
                    <label for="v-destaque">Marcar como Destaque</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="v-ativo">
                    <label for="v-ativo">Ve√≠culo Ativo (Vis√≠vel no Cat√°logo)</label>
                </div>
            </div>

            <!-- FICHA T√âCNICA (Inputs Simplificados) -->
            <h4 style="margin-top:20px;color:var(--muted)">Ficha T√©cnica (Essencial)</h4>
             <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px">
                <div class="form-group">
                    <label for="v-category">Categoria</label>
                    <select id="v-category">
                        <option value="Hatch">Hatch</option>
                        <option value="Sedan">Sedan</option>
                        <option value="SUV">SUV</option>
                        <option value="Caminhonete">Caminhonete</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="v-gearbox">C√¢mbio</label>
                    <select id="v-gearbox">
                        <option value="Autom√°tico">Autom√°tico</option>
                        <option value="Manual">Manual</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="v-fuel">Combust√≠vel</label>
                    <select id="v-fuel">
                        <option value="Flex">Flex</option>
                        <option value="Diesel">Diesel</option>
                        <option value="El√©trico">El√©trico</option>
                        <option value="H√≠brido">H√≠brido</option>
                    </select>
                </div>
            </div>

            <div style="margin-top: 30px; display:flex; justify-content:flex-end; gap:10px">
                <button type="button" class="btn soft" onclick="closeEditModal()">Cancelar</button>
                <button type="submit" class="btn primary">Salvar Ve√≠culo</button>
            </div>
        </form>
    </div>
</div>

<div class="wa-float">
  <a id="waFloat" class="btn wa" href="#" target="_blank" rel="noreferrer" title="Falar com o seu Consultor">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12.036 1c-6.046 0-10.964 4.918-10.964 10.964 0 2.059.571 4.026 1.636 5.766L1 23l5.525-1.503c1.677.925 3.58 1.408 5.511 1.408 6.045 0 10.964-4.918 10.964-10.964S18.081 1 12.036 1zm4.613 13.567c-.201.353-.699.712-1.018.751-.309.043-.655.051-1.026-.178-.445-.268-1.464-.567-2.802-1.787-1.025-.929-1.706-2.062-1.895-2.388-.189-.326-.008-.5.163-.679.16-.164.353-.404.53-.615.176-.214.23-.365.346-.615.118-.255.061-.47-.03-.667-.09-.199-.817-1.996-1.119-2.732-.294-.716-.583-.615-.8-.615-.205 0-.445-.022-.686-.022-.236 0-.622.088-.94.437-.319.344-1.21 1.187-1.21 2.897s1.246 3.354 1.419 3.585c.174.23.292.49.544.835 1.096 1.488 2.079 2.082 3.195 2.62.339.166.577.27.778.337.247.086.536.069.734-.029.23-.112.721-.347 1.258-.813.593-.526 1.077-.942 1.231-.177.155.766.155 1.411.085 1.545-.069.135-.201.217-.406.326z"/></svg>
    Consultoria WhatsApp
  </a>
</div>

<footer class="wrap">
  ¬© <span id="y"></span> Vega Automotores, Concession√°ria Oficial Volkswagen. Todos os direitos reservados.
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// =================================================================
// 1. CONFIGURA√á√ïES (J√Å ATUALIZADAS COM SEUS DADOS)
// =================================================================
const VENDEDOR_NAME = "Marcelo Macedo";
const CONCESSIONARIA_NAME = "Vega Automotores";
const BRAND_NAME = "Volkswagen";
const DEALER_CITY_STATE = "Bel√©m/PA";

// Configura√ß√µes do Supabase (Substitu√≠das com seus dados)
const SUPABASE_URL  = "https://fjsqcmhnqyjdbyqhllvj.supabase.co"; 
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqc3FjbWhucXlqZGJ5cWhsbHZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODc2ODMsImV4cCI6MjA3ODM2MzY4M30.mVpcSHpP55_60suOKIHY6l9RRP8GTG1XcjM1H7lhpMs"; 
const DEALER_DEFAULT_PHONE = "5591999998888"; // Telefone padr√£o (55 + DDD + N√∫mero)

// URL da foto do Marcelo (Utilizada no Card do Vendedor)
const VENDEDOR_PHOTO_URL = "https://i.postimg.cc/BnNvBn0J/unnamed.jpg";

// Inicializa√ß√£o do Supabase Client
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// Vari√°vel global para armazenar o perfil do Dealer ap√≥s o login
let DEALER_PROFILE = null; 

// =================================================================
// 2. HELPERS
// =================================================================
const $ = (s, c=document) => c.querySelector(s);
const BRL = (n) => (Number(n)||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const digits = (s) => String(s||"").replace(/\D/g,"");
const WA = (digits, t="Ol√°!") => "https://wa.me/" + digits + "?text=" + encodeURIComponent(t);
const show = (id) => { 
  const pages = ["page-portfolio", "page-catalogo", "page-detalhe", "page-admin"];
  pages.forEach(x => $("#"+x).classList.add("hide")); 
  if($("#"+id)) $("#"+id).classList.remove("hide"); 
};
const debounce = (fn, ms=200) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
let dealerPhone = DEALER_DEFAULT_PHONE;

// DEMO Data (Simplificada para brevidade)
const DEMO = [
  { id: "demo1", title:"VW T-Cross Comfortline 200 TSI", year:2025, km:0, gearbox:"Autom√°tico", fuel:"Flex", price:135990, promotion_tag:"Lan√ßamento 2025", destaque:true, promotion_text:"B√≥nus de R$ 8.000 na troca do seu usado!", photos:["https://placehold.co/960x640/002975/FFF?text=VW+T-Cross+2025"] , ficha_tecnica: { Categoria: "SUV", Motor: "1.0 TSI Turbo", C√¢mbio: "Autom√°tico 6 marchas", Airbags: "6", Central: "VW Play 10.1\"" } },
  { id: "demo2", title:"VW Polo Track 1.0 MPI", year:2025, km:0, gearbox:"Manual", fuel:"Flex", price:87990, promotion_tag:"Pre√ßo de F√°brica", destaque:true, promotion_text:"Taxa Zero em 24x!", photos:["https://placehold.co/960x640/002975/FFF?text=VW+Polo+Track"] , ficha_tecnica: { Categoria: "Hatch", Motor: "1.0 MPI", C√¢mbio: "Manual 5 marchas", Airbags: "4" } },
  { id: "demo3", title:"VW Virtus Highline 200 TSI", year:2024, km:0, gearbox:"Autom√°tico", fuel:"Flex", price:149990, promotion_tag:"Taxa 0.99%", destaque:false, promotion_text:"Primeira parcela para 90 dias!", photos:["https://placehold.co/960x640/002975/FFF?text=VW+Virtus+Highline"] , ficha_tecnica: { Categoria: "Sedan", Motor: "1.0 TSI Turbo", C√¢mbio: "Autom√°tico 6 marchas", Airbags: "6" } },
  { id: "demo4", title:"VW Nivus Comfortline 200 TSI", year:2024, km:0, gearbox:"Autom√°tico", fuel:"Flex", price:129990, promotion_tag:"√öltimas Unidades", destaque:false, promotion_text:"B√≥nus Especial para fechar o m√™s!", photos:["https://placehold.co/960x640/002975/FFF?text=VW+Nivus+Comfortline"] , ficha_tecnica: { Categoria: "SUV", Motor: "1.0 TSI Turbo", C√¢mbio: "Autom√°tico 6 marchas", Airbags: "6" } },
  { id: "demo5", title:"VW Taos Comfortline 250 TSI", year:2024, km:0, gearbox:"Autom√°tico", fuel:"Flex", price:185000, promotion_tag:"Venda Direta", destaque:false, promotion_text:"Desconto Frotista/CNPJ", photos:["https://placehold.co/960x640/002975/FFF?text=VW+Taos+SUV"] , ficha_tecnica: { Categoria: "SUV", Motor: "1.4 TSI Turbo", C√¢mbio: "Autom√°tico 6 marchas", Airbags: "6" } },
];


// =================================================================
// 3. CATALOGO & VENDOR INFO
// =================================================================
let cache = [];

async function fetchVehicles(){
  // Fetch/Set Dealer Info
  const { data: dealerData } = await sb.from("dealer").select("*").maybeSingle();
  if(dealerData){
    $("#dealerLocation").textContent = `${dealerData.concessionaria_name || CONCESSIONARIA_NAME} ‚Ä¢ ${dealerData.city || DEALER_CITY_STATE}`;
    $("#bioVendedor").textContent = dealerData.bio_vendedor || $("#bioVendedor").textContent;
    $("#bioConcessionaria").textContent = dealerData.bio_concessionaria || $("#bioConcessionaria").textContent;
    const kpis = dealerData.kpis || {};
    $("#kpi-clientes").textContent = kpis.clientes || "1.500+";
    $("#kpi-anos").textContent = kpis.anos || "10 Anos";
    setDealerWA(dealerData.whatsapp);
  } else {
    $("#dealerLocation").textContent = `${CONCESSIONARIA_NAME} ‚Ä¢ ${DEALER_CITY_STATE}`;
  }
  
  // Define a foto do vendedor na UI
  $("#vendedorPhoto").src = VENDEDOR_PHOTO_URL;

  // Fetch Vehicles
  const { data, error } = await sb.from("vehicle").select("*").eq("status", "ativo").order("destaque",{ascending:false}).order("year",{ascending:false});
  // Se o Supabase estiver vazio (ap√≥s apagar tudo), usa os dados DEMO
  cache = (!error && data && data.length) ? data : DEMO;
  renderCatalog();
  $("#count").textContent = cache.length;
}

function cardHTML(v){
  const foto = (v.photos && v.photos[0]) || `https://placehold.co/960x640/002975/FFF?text=${v.title||'Sem Foto'}`;
  const meta = [v.year, "Zero Km"].filter(Boolean).join(" ‚Ä¢ ");
  const promo_tag = v.promotion_tag ? `<span class="promo-tag" style="background:var(--wa);color:white;top:10px;left:auto;right:10px;box-shadow:0 0 8px rgba(0,0,0,.3);position:absolute;padding:6px 12px;border-radius:999px;font-size:12px;font-weight:700;">${v.promotion_tag}</span>` : '';

  return `<article class="card">
    <a href="#/carro/${v.id}" onclick="return navDetalhe('${v.id}')">
      <div class="thumb">${promo_tag}<img src="${foto}" alt="${v.title||''}" onerror="this.onerror=null;this.src='https://placehold.co/960x640/002975/FFF?text=${BRAND_NAME}';" style="border-radius:16px 16px 0 0;"></div>
    </a>
    <div class="pad">
      <div class="title">${v.title||""}</div>
      <div class="meta">${meta}</div>
      <div style="font-size:14px;color:var(--accent-vw);font-weight:700;min-height:30px">${v.promotion_text||''}</div>
      <div class="price">${BRL(v.price)}</div>
      <div style="display:flex;gap:8px">
        <a class="btn wa" href="#" onclick="return interesse('${v.id}')">Desbloquear Condi√ß√£o Exclusiva</a>
      </div>
    </div>
  </article>`;
}

function renderFeatured(){
  const el = $("#featured");
  const arr = cache.filter(v => v.destaque);
  el.innerHTML = arr.map(cardHTML).join("") || `<div class='muted' style="padding:10px;grid-column:1/-1">Sem destaques no momento. Verifique o estoque completo.</div>`;
}

function renderCatalog(){
  const q  = $("#q").value.trim().toLowerCase();
  const fModel = $("#fModel").value;
  const fy = $("#fy").value;
  const fCat = $("#fCat").value;
  const fs = $("#fs").value;
  
  let list = cache.filter(v => (
    (!q || (v.title||'').toLowerCase().includes(q) || (v.promotion_tag||'').toLowerCase().includes(q)) &&
    (!fModel || (v.title||'').includes(fModel)) &&
    (!fy || v.year >= +fy) &&
    (!fCat || (v.ficha_tecnica?.Categoria === fCat))
  ));
  
  renderFeatured();
  
  list = list.filter(v => !v.destaque);

  switch(fs){
    case "price-asc":  list.sort((a,b)=> (a.price||0)-(b.price||0)); break;
    case "price-desc": list.sort((a,b)=> (b.price||0)-(a.price||0)); break;
    default:           list.sort((a,b)=> (b.year||0)-(a.year||0)); break;
  }
  $("#list").innerHTML = list.map(cardHTML).join("") || "<p class='muted' style='grid-column:1/-1'>Nenhum ve√≠culo encontrado no cat√°logo.</p>";
}

function navDetalhe(id){
  const v = cache.find(x => x.id == id);
  if(!v) return false;
  show("page-detalhe");
  const foto = (v.photos && v.photos[0]) || `https://placehold.co/1200x700/002975/FFF?text=${v.title||'Sem Foto'}`;
  
  $("#dt-title-main").textContent = v.title||"";
  $("#dt-foto").innerHTML = `<img src="${foto}" alt="${v.title}" style="width:100%;height:100%;object-fit:cover;border-radius:12px">`;
  $("#dt-promo").textContent = v.promotion_text || '';
  $("#dt-meta").textContent = [v.year, v.ficha_tecnica?.C√¢mbio || v.gearbox, v.fuel, "Zero Km"].filter(Boolean).join(" ‚Ä¢ ");
  $("#dt-price").textContent = BRL(v.price);
  
  const specs = v.ficha_tecnica ? Object.entries(v.ficha_tecnica).map(([key, val]) => `<li>${key}: ${val}</li>`).join("") : "<li>Ficha t√©cnica completa dispon√≠vel via WhatsApp.</li>";
  $("#dt-specs").innerHTML = specs;
  
  const entrada = $("#s-entrada"), meses=$("#s-meses"), taxa=$("#s-taxa"), parc=$("#s-parcela");
  const priceBase = v.price || 0;

  const recalc = ()=>{
    const e = +entrada.value||0, m=+meses.value||1, i=(+taxa.value||0)/100, pv=Math.max(0,priceBase-e);
    const p = (i>0)? (pv*i)/(1-Math.pow(1+i,-m)) : (pv/m);
    parc.textContent = BRL(p);
  };
  [entrada,meses,taxa].forEach(inp => inp.oninput = recalc); recalc();
  $("#btnProposta-dt").onclick = ()=> interesse(v.id, true);
  return false;
}

async function interesse(id, isDetail=false){
  const v = cache.find(x => x.id == id); if(!v) return false;
  let sim = '';
  if(isDetail){
    // Captura os valores do simulador na p√°gina de detalhe
    sim = ` Simula√ß√£o: Entrada R$${$("#s-entrada").value || 'N√£o informada'} em ${$("#s-meses").value || '48'}x de ${$("#s-parcela").textContent}.`;
  }
  const msg = `Ol√° Marcelo! Vi na sua vitrine o ${v.title} (${v.year}) por ${BRL(v.price)}.${sim} Gostaria de avan√ßar com a proposta.`;
  
  // Envio de lead para o Supabase (mesmo que falhe, n√£o impede o WhatsApp)
  try{ 
    await sb.from("lead").insert({ vehicle_id:id, channel:"whatsapp", utm_source:"site", utm_medium:"proposta", utm_campaign:"catalog", message: msg }); 
  }catch(e){
    console.warn("Erro ao registrar lead no Supabase:", e.message);
  }

  location.href = WA(dealerPhone, msg);
  return false;
}

// =================================================================
// 4. AUTH & ADMIN FUNCTIONS
// =================================================================

function togglePasswordVisibility() {
  const passwordInput = $("#auth-password");
  const iconContainer = $("#eye-icon");
  if (passwordInput.type === "password") {
    passwordInput.type = "text";
    // √çcone de olho aberto (simplificado)
    iconContainer.innerHTML = '<path d="M12 4s3 7 10 7-3 7-10 7-10-7-10-7z"></path><circle cx="12" cy="12" r="3"></circle>'; 
  } else {
    passwordInput.type = "password";
    // √çcone de olho fechado (simplificado)
    iconContainer.innerHTML = '<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"></path><circle cx="12" cy="12" r="3"></circle>'; 
  }
}
window.togglePasswordVisibility = togglePasswordVisibility;

$("#btn-login").onclick = async ()=>{
  const email = $("#auth-email").value.trim();
  const password = $("#auth-password").value.trim();
  if (!email || !password) return alert("Por favor, preencha o email e a senha.");
  
  // Adicionando tratamento de erro mais amig√°vel
  try {
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if(error) {
      alert(`Erro no Login: ${error.message}. Verifique suas credenciais.`);
    }
  } catch(e) {
    alert(`Erro de conex√£o/servidor: ${e.message}`);
  }
  // O onAuthStateChange tratar√° o sucesso
};

$("#btn-google-login").onclick = async ()=>{
  try {
    const { error } = await sb.auth.signInWithOAuth({ provider: 'google' });
    if (error) alert(`Erro no Login com Google: ${error.message}`);
  } catch(e) {
    alert(`Erro de conex√£o/servidor: ${e.message}`);
  }
};


$("#logout").onclick = async ()=>{
  await sb.auth.signOut();
  $("#box-app").classList.add("hide");
  $("#box-login").classList.remove("hide");
  route('portfolio');
};

function setDealerWA(phoneRaw){
  const d = digits(phoneRaw);
  if(d.length>=11){
    dealerPhone = d;
    const waMsg = `Ol√° Marcelo! Gostaria de iniciar a minha consultoria para comprar um VW Zero Km.`;
    $("#btnWA-bottom").href = WA(dealerPhone, waMsg);
    $("#waFloat").href = WA(dealerPhone, waMsg);
  }else{
    dealerPhone = DEALER_DEFAULT_PHONE;
  }
}

async function injectAdminLink(){
  const { data: { session } } = await sb.auth.getSession();
  const loginAdminBtn = $("#loginAdminBtn");
  const loginIcon = $("#login-icon"); // O √≠cone dentro do bot√£o

  if(session){
    // Usu√°rio LOGADO: Mostra o √≠cone de usu√°rio e o link leva para o Painel.
    if(loginAdminBtn){
      loginAdminBtn.title = "√Årea Admin";
      // √çcone de Ponto/Check (sugere que a sess√£o est√° ativa)
      loginIcon.innerHTML = '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle><circle cx="18" cy="18" r="3" fill="var(--wa)" stroke="var(--card)" stroke-width="1.5"/>';
    }
    if(location.hash === '#/admin') bootstrapAdmin(session);
  } else {
    // Usu√°rio DESLOGADO: Mostra o √≠cone de cadeado/perfil padr√£o.
    if(loginAdminBtn){
      loginAdminBtn.title = "Login Consultor";
      // √çcone de Perfil Padr√£o
      loginIcon.innerHTML = '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>';
    }
    // Garante que o usu√°rio deslogado na rota admin veja o formul√°rio
    if(location.hash === '#/admin') {
      show('page-admin');
      $("#box-login").classList.remove("hide");
      $("#box-app").classList.add("hide");
    }
  }
}

async function bootstrapAdmin(session){
  if(!session) return;
  show('page-admin');
  $("#box-login").classList.add("hide");
  $("#box-app").classList.remove("hide");
  const user = session.user;

  // 1. Fetch/Setup Dealer Profile
  let { data: dealerProfile } = await sb.from("dealer").select("*").maybeSingle();
  if(!dealerProfile){
    // Cria o perfil do Dealer se n√£o existir (IMPORTANTE para nova integra√ß√£o)
    const profileData = { vendedor_name: VENDEDOR_NAME, concessionaria_name: CONCESSIONARIA_NAME, brand: BRAND_NAME, city: DEALER_CITY_STATE.split('/')[0], whatsapp: DEALER_DEFAULT_PHONE, created_by: user.id };
    const { data, error } = await sb.from("dealer").insert(profileData).select("*").single();
    if(error) { console.error("Erro no bootstrap do dealer:", error); return; }
    dealerProfile = data;
  }
  
  DEALER_PROFILE = dealerProfile; // Armazena o perfil globalmente
  $("#dealerInfo").textContent = `${dealerProfile.vendedor_name} (${dealerProfile.concessionaria_name}) ‚Ä¢ ${dealerProfile.whatsapp}`;
  setDealerWA(dealerProfile.whatsapp);
  
  // 2. Setup Admin Functions
  async function listAdmin(){
    
    if(!DEALER_PROFILE || !DEALER_PROFILE.id) {
        $("#listAdmin").innerHTML = "<div class='muted'>Erro ao carregar ID do Dealer. Tente Sair e Entrar novamente.</div>";
        return;
    }
    
    const { data } = await sb.from("vehicle").select("id,title,price,year,status,destaque,promotion_tag").eq("dealer_id", DEALER_PROFILE.id).order("updated_at",{ascending:false});
    
    // Renderiza a lista (mantido o layout anterior)
    $("#listAdmin").innerHTML = (data||[]).map(v => `
      <div class="card pad" style="display:flex;gap:15px;align-items:center;flex-wrap:wrap;padding:12px;box-shadow:none">
        <div style="flex:1">
          <strong>${v.title}</strong> ‚Ä¢ ${v.year} ‚Ä¢ ${BRL(v.price)} <br>
          <span class="muted" style="font-size:12px">${v.promotion_tag||'Sem Promo'} | Status: ${v.status} ${v.destaque?'| DESTAQUE':''}</span>
        </div>
        <button class="btn soft" onclick="admFoto('${v.id}','${DEALER_PROFILE.id}')">Fotos</button>
        <!-- admEdit chama o novo modal -->
        <button class="btn soft" onclick="openEditModal('${v.id}')">Editar</button> 
        <button class="btn soft" onclick="admToggle('${v.id}')">${v.status==='ativo'?'Pausar':'Ativar'}</button>
        <button class="btn soft" onclick="admStar('${v.id}')">${v.destaque?'Normal':'Destacar'}</button>
      </div>
    `).join("") || "<div class='muted'>Sem ve√≠culos. Use + Novo Carro ou Seed.</div>";
  }
  window.listAdmin = listAdmin;
  
  // NEW: Novo Carro agora chama o modal vazio
  $("#newCar").onclick = () => openEditModal(); 
  window.openEditModal = openEditModal; // Exp√µe a fun√ß√£o para ser usada pelo onclick nos cart√µes

  // Fun√ß√µes administrativas restantes (mantidas)
  $("#seed").onclick = async ()=>{
    if(!confirm("Inserir 5 ve√≠culos de exemplo no banco?")) return;
    if (!DEALER_PROFILE || !DEALER_PROFILE.id) return alert("Erro: ID do Dealer n√£o encontrado. Fa√ßa login novamente.");
    
    const payload = DEMO.map(v => ({ 
      dealer_id: DEALER_PROFILE.id, 
      title:v.title, 
      year:v.year, 
      price:v.price, 
      gearbox:v.gearbox, 
      fuel:v.fuel, 
      status:"ativo", 
      destaque:!!v.destaque, 
      promotion_tag:v.promotion_tag, 
      promotion_text:v.promotion_text, 
      ficha_tecnica: v.ficha_tecnica || {}
    }));
    const { error } = await sb.from("vehicle").insert(payload);
    if(error) alert(`Erro ao inserir Seed: ${error.message}`); else listAdmin();
  };

  $("#refresh").onclick = ()=> listAdmin();

  window.admToggle = async (id)=>{
    const { data: v, error } = await sb.from("vehicle").select("status").eq("id", id).single();
    if (error) return alert(`Erro ao buscar status: ${error.message}`);
    const { error: updateError } = await sb.from("vehicle").update({ status: (v.status==='ativo'?'pausado':'ativo') }).eq("id", id);
    if (updateError) return alert(`Erro ao atualizar status: ${updateError.message}`);
    listAdmin(); fetchVehicles();
  };
  
  // Antiga admEdit removida e substitu√≠da por openEditModal
  window.admEdit = openEditModal;

  window.admStar = async (id)=>{
    const { data: v, error } = await sb.from("vehicle").select("destaque").eq("id", id).single();
    if (error) return alert(`Erro ao buscar destaque: ${error.message}`);
    const { error: updateError } = await sb.from("vehicle").update({ destaque: !v.destaque }).eq("id", id);
    if (updateError) return alert(`Erro ao atualizar destaque: ${updateError.message}`);
    listAdmin(); fetchVehicles();
  };

  window.admFoto = async (id, dealerId)=>{
    const input = Object.assign(document.createElement("input"),{ type:"file", accept:"image/*", multiple:true });
    input.onchange = async ()=>{
      if(!input.files.length) return;
      
      const existingPhotos = (await sb.from("vehicle").select("photos").eq("id", id).single()).data?.photos || [];
      
      for(let i=0; i<input.files.length; i++){
          const file = input.files[i];
          const path = `photos/${dealerId}/${id}/${Date.now()}-${file.name}`;
          const up = await sb.storage.from("car-photos").upload(path, file, { cacheControl:"3600", upsert:false });
          if(up.error) { console.error(up.error.message); alert(`Erro ao enviar foto: ${up.error.message}`); continue; }
          
          const { data: publicData } = sb.storage.from("car-photos").getPublicUrl(path);
          const url = publicData.publicUrl;
          existingPhotos.push(url);
      }
      
      const { error } = await sb.from("vehicle").update({ photos: existingPhotos }).eq("id", id);
      if (error) alert(`Erro ao salvar links das fotos: ${error.message}`);
      else alert(`${input.files.length} foto(s) enviada(s)!`);
      listAdmin();
    };
    input.click();
  };
  listAdmin();
}

// =================================================================
// 5. FUN√á√ïES DO NOVO MODAL DE EDI√á√ÉO/CRIA√á√ÉO
// =================================================================

function closeEditModal() {
    $("#edit-modal").classList.add("hide");
    // Reseta o formul√°rio
    $("#vehicle-form").reset();
    $("#v-id").value = '';
}
window.closeEditModal = closeEditModal;

async function openEditModal(id = null) {
    if (!DEALER_PROFILE) {
        alert("Erro: Perfil do consultor n√£o carregado. Tente fazer login novamente.");
        return;
    }
    
    // 1. Configura o modal para edi√ß√£o ou cria√ß√£o
    if (id) {
        $("#modal-title").textContent = "Editar Ve√≠culo";
        // Busca os dados do ve√≠culo no cache
        const v = cache.find(x => x.id === id);
        if (!v) {
            alert("Ve√≠culo n√£o encontrado no cache.");
            return;
        }
        
        // 2. Preenche os campos do formul√°rio
        $("#v-id").value = v.id;
        $("#v-title").value = v.title || '';
        $("#v-price").value = v.price || '';
        $("#v-year").value = v.year || new Date().getFullYear();
        $("#v-promo-tag").value = v.promotion_tag || '';
        $("#v-promo-text").value = v.promotion_text || '';
        $("#v-destaque").checked = !!v.destaque;
        $("#v-ativo").checked = v.status === 'ativo';
        
        // Ficha T√©cnica (com fallback)
        $("#v-category").value = v.ficha_tecnica?.Categoria || v.ficha_tecnica?.Categoria || 'Hatch';
        $("#v-gearbox").value = v.ficha_tecnica?.C√¢mbio || v.gearbox || 'Autom√°tico';
        $("#v-fuel").value = v.fuel || 'Flex';
        
    } else {
        $("#modal-title").textContent = "Novo Ve√≠culo";
        $("#v-id").value = ''; // Garante que o ID esteja vazio para a cria√ß√£o
        $("#v-ativo").checked = true; // Novo carro come√ßa como ativo
    }
    
    // LINHA QUE MOSTRA O MODAL
    $("#edit-modal").classList.remove("hide"); 
}
window.openEditModal = openEditModal;

async function saveVehicle() {
    // 1. Coleta os dados do formul√°rio
    const id = $("#v-id").value;
    const title = $("#v-title").value.trim();
    const price = +$("#v-price").value;
    const year = +$("#v-year").value;
    const promo_tag = $("#v-promo-tag").value.trim();
    const promo_text = $("#v-promo-text").value.trim();
    const destaque = $("#v-destaque").checked;
    const status = $("#v-ativo").checked ? 'ativo' : 'pausado';
    
    const category = $("#v-category").value;
    const gearbox = $("#v-gearbox").value;
    const fuel = $("#v-fuel").value;
    
    if (!title || !price || !year) {
        alert("T√≠tulo, Pre√ßo e Ano s√£o obrigat√≥rios.");
        return false;
    }

    const payload = {
        title,
        price,
        year,
        gearbox,
        fuel,
        status,
        destaque,
        promotion_tag: promo_tag,
        promotion_text: promo_text,
        ficha_tecnica: {
            Categoria: category,
            C√¢mbio: gearbox,
            Motor: "TSI", // Padr√£o
            Airbags: "6"  // Padr√£o
        }
    };
    
    let error;

    if (id) {
        // Edi√ß√£o (UPDATE)
        const result = await sb.from("vehicle").update(payload).eq("id", id);
        error = result.error;
    } else {
        // Cria√ß√£o (INSERT)
        if (!DEALER_PROFILE || !DEALER_PROFILE.id) {
            alert("Erro: ID do Dealer n√£o encontrado. Fa√ßa login novamente.");
            return false;
        }
        payload.dealer_id = DEALER_PROFILE.id;
        const result = await sb.from("vehicle").insert(payload);
        error = result.error;
    }

    if (error) {
        alert(`Erro ao salvar ve√≠culo: ${error.message}`);
        return false;
    }

    // 2. Fecha o modal e atualiza as listas
    closeEditModal();
    listAdmin(); 
    fetchVehicles(); // Atualiza o cat√°logo p√∫blico
    
    return false; // Previne o envio padr√£o do formul√°rio
}
window.saveVehicle = saveVehicle;

// =================================================================
// 6. AUTH WIRING
// =================================================================
sb.auth.getSession().then(({ data })=>{ if(data.session){ bootstrapAdmin(data.session); } });
sb.auth.onAuthStateChange((_evt, s)=>{ 
    if(s?.session){ 
        bootstrapAdmin(s.session); 
    } else {
        // Se deslogado e na p√°gina admin, exibe a caixa de login
        if(location.hash === '#/admin') {
            show('page-admin');
            $("#box-login").classList.remove("hide");
            $("#box-app").classList.add("hide");
        }
    }
    injectAdminLink();
});

// 7. ROUTER
function route(path, filter){
  if(path==="portfolio"){ show("page-portfolio"); return false; }
  if(path==="catalogo"){ 
    show("page-catalogo"); 
    fetchVehicles(); 
    const q = $("#q");
    if(filter === 'lancamentos') { q.value = '2025'; q.dispatchEvent(new Event('input')); }
    if(filter === 'promocao') { q.value = 'b√≥nus'; q.dispatchEvent(new Event('input')); }
    if(filter === 'modelos') { q.value = ''; q.dispatchEvent(new Event('input')); }
    return false; 
  }
  if(path==="admin"){ 
    // Tenta obter a sess√£o novamente (pode ser necess√°rio ap√≥s recarga)
    sb.auth.getSession().then(({ data: { session } }) => {
        if (session) {
            bootstrapAdmin(session);
        } else {
            show('page-admin');
            $("#box-login").classList.remove("hide");
            $("#box-app").classList.add("hide");
        }
    });
    return false; 
  }
  return false;
}
window.addEventListener("hashchange", ()=>{
  const h = location.hash.split("/");
  if(h[1]==="carro" && h[2]){ navDetalhe(h[2]); }
  else if(h[1]==="catalogo"){ 
    const urlParams = new URLSearchParams(location.hash.substring(location.hash.indexOf('?')+1));
    // Verifica se h√° um filtro na URL antes de chamar route('catalogo')
    route('catalogo', urlParams.get('filter') || undefined); 
  }
  else if(h[1]==="admin"){ route('admin'); }
  else { route('portfolio'); }
  injectAdminLink();
});

// 8. INIT & REALTIME
document.getElementById("y").textContent = new Date().getFullYear();
["#q","#fModel","#fy","#fCat","#fs"].forEach(sel => document.querySelector(sel).addEventListener("input", debounce(renderCatalog,120)));
sb.channel("rt").on("postgres_changes", { event:"*", schema:"public", table:"vehicle" }, fetchVehicles).subscribe();

// LINHA DE SEGURAN√áA ADICIONADA: Garante que o modal est√° invis√≠vel ao carregar
$("#edit-modal").classList.add("hide"); 

// Redireciona para a rota correta ao carregar a p√°gina
if(location.hash){ window.dispatchEvent(new Event('hashchange')); }
else { route('portfolio'); }

injectAdminLink();
fetchVehicles();
</script>
</body>
</html>
