<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Marcelo Macedo • Vitrine de Seminovos</title>
<meta name="description" content="Vitrine de seminovos com proposta rápida no WhatsApp e painel administrativo completo.">
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --line:rgba(255,255,255,.10);
    --muted:#9aa6b2; --text:#eaf2ff; --brand:#25D366; --brand-ink:#032313;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1200px;margin:0 auto;padding:0 14px}
  header{position:sticky;top:0;z-index:60;background:linear-gradient(180deg,rgba(2,6,23,.94),rgba(2,6,23,.75));border-bottom:1px solid var(--line);backdrop-filter:blur(10px)}
  h1{font-size:clamp(18px,3vw,24px);margin:8px 0}
  .muted{color:var(--muted)}
  .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#101a2c;color:#eaf2ff;text-decoration:none;cursor:pointer;user-select:none}
  .btn.primary{background:var(--brand);color:var(--brand-ink);border-color:transparent;font-weight:800}
  .btn.ghost{background:transparent}
  .btn.warn{background:#2a100f;border-color:#5f1d1b}
  .chip{padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin:14px 0 22px}
  @media(max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:640px){.grid{grid-template-columns:1fr}}
  .card{border:1px solid var(--line);border-radius:16px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02))}
  .thumb{aspect-ratio:16/10;background:#0a1324}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .pad{padding:12px}
  .title{font-weight:800;margin:2px 0}
  .meta{font-size:13px;color:var(--muted)}
  .price{font-size:20px;font-weight:900;margin:8px 0}
  .filters{display:grid;grid-template-columns:1fr 130px 150px 150px 170px;gap:10px;margin-top:12px}
  input,select{padding:12px 12px;border-radius:12px;border:1px solid var(--line);background:#0f1624;color:#eaf2ff}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin-top:16px}
  .hero{display:grid;grid-template-columns:1fr 360px;gap:16px}
  @media(max-width:960px){.hero{grid-template-columns:1fr}}
  .stack{display:grid;gap:10px}
  footer{border-top:1px solid var(--line);color:#b7c3cf;padding:16px;margin-top:20px}
  .hide{display:none}
  /* menu */
  .icon{width:40px;height:40px;border:1px solid var(--line);border-radius:12px;background:#0f1624;display:grid;place-items:center;cursor:pointer}
  .icon span{display:block;width:18px;height:2px;background:#e6f0ff;margin:2px 0;border-radius:2px}
  .menu{position:absolute;right:14px;top:60px;background:#0f1624;border:1px solid var(--line);border-radius:12px;overflow:hidden;display:none;min-width:170px}
  .menu.open{display:block}
  .menu a, .menu button{display:block;width:100%;text-align:left;padding:10px 12px;border-bottom:1px solid var(--line);background:transparent;color:#eaf2ff;text-decoration:none}
  .menu a:last-child, .menu button:last-child{border-bottom:0}
  /* admin */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media(max-width:640px){.kpi{grid-template-columns:1fr}}
  .kpi .card{padding:12px}
  .table{border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .row{display:grid;grid-template-columns:1.5fr .6fr .4fr .5fr .6fr .8fr .9fr;gap:10px;align-items:center;border-bottom:1px solid var(--line);padding:10px}
  .row.head{background:#0f1624;color:#cfe2ff;font-weight:700}
  .row:last-child{border-bottom:0}
  .photo-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  @media(max-width:900px){.photo-grid{grid-template-columns:repeat(2,1fr)}}
  .ph{position:relative;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#091327}
  .ph img{width:100%;height:150px;object-fit:cover;display:block}
  .ph .bar{position:absolute;left:0;right:0;bottom:0;background:linear-gradient(180deg,transparent,rgba(0,0,0,.5));padding:6px;display:flex;gap:6px;justify-content:flex-end}
  .ph .tag{position:absolute;left:6px;top:6px;background:#0007;color:#fff;padding:2px 6px;border-radius:999px;font-size:11px}
  .over{position:fixed;inset:0;background:rgba(1,5,20,.7);display:none;place-items:center;z-index:90}
  .over.open{display:grid}
  .panel{width:min(920px,90vw);max-height:90vh;overflow:auto;background:#0c1529;border:1px solid var(--line);border-radius:16px;padding:14px}
  /* WA flutuante */
  .wa{position:fixed;right:16px;bottom:16px;width:56px;height:56px;border-radius:999px;background:var(--brand);color:var(--brand-ink);display:flex;align-items:center;justify-content:center;font-weight:900;text-decoration:none;box-shadow:0 8px 24px rgba(37,211,102,.35);z-index:70}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 0;position:relative">
    <div>
      <h1>Marcelo Macedo • Vitrine de Seminovos</h1>
      <div class="muted" style="font-size:13px">Catálogo conectado ao Supabase • Proposta rápida no WhatsApp</div>
    </div>
    <nav style="display:flex;gap:10px;align-items:center">
      <a class="btn" href="#/estoque" onclick="return route('estoque')">Estoque</a>
      <div class="icon" id="menuBtn" aria-label="Menu"><span></span><span></span><span></span></div>
      <div class="menu" id="menu">
        <a href="#/admin" onclick="return route('admin')">Admin</a>
        <button id="btnLogout">Sair</button>
      </div>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- ESTOQUE / HOME -->
  <section id="page-estoque">
    <div class="filters">
      <input id="q" type="search" placeholder="Buscar por modelo/marca…">
      <select id="fy"><option value="">Ano min.</option><option>2025</option><option>2024</option><option>2023</option><option>2022</option></select>
      <select id="ff"><option value="">Combustível</option><option>Flex</option><option>Gasolina</option><option>Diesel</option><option>Híbrido</option><option>Elétrico</option></select>
      <select id="fg"><option value="">Câmbio</option><option>Automático</option><option>Manual</option></select>
      <select id="fs"><option value="recent">Mais recentes</option><option value="price-asc">Menor preço</option><option value="price-desc">Maior preço</option><option value="km-asc">Menor KM</option></select>
    </div>
    <div class="section-title">
      <h2 style="margin:12px 0">Ofertas em destaque</h2>
      <span class="chip">Atualiza em tempo real</span>
    </div>
    <div id="featured" class="grid"></div>

    <div class="section-title">
      <h2 style="margin:12px 0">Estoque completo</h2>
      <span class="chip"><span id="count">0</span> veículos</span>
    </div>
    <div id="list" class="grid"></div>
  </section>

  <!-- DETALHE -->
  <section id="page-detalhe" class="hide">
    <div class="hero">
      <div class="card">
        <div class="thumb" id="dt-foto"></div>
        <div class="pad stack">
          <div class="title" id="dt-title"></div>
          <div class="meta" id="dt-meta"></div>
          <div class="price" id="dt-price"></div>
        </div>
      </div>
      <aside class="stack">
        <div class="card pad">
          <div class="muted" style="font-size:12px">Entrada (R$)</div><input id="s-entrada" type="number" value="20000">
          <div class="muted" style="font-size:12px">Meses</div><input id="s-meses" type="number" value="48">
          <div class="muted" style="font-size:12px">Taxa mensal (%)</div><input id="s-taxa" type="number" step="0.01" value="1.75">
          <div class="muted" style="font-size:12px;margin-top:6px">Parcela estimada</div>
          <div id="s-parcela" class="price">R$ 0,00</div>
          <button id="btnProposta" class="btn primary" style="width:100%;margin-top:10px">Proposta rápida</button>
        </div>
      </aside>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="page-admin" class="hide">
    <!-- LOGIN -->
    <div id="adm-login" class="card pad">
      <h2>Admin • Acesso</h2>
      <div class="muted" style="font-size:13px">Receba um link mágico no e-mail para gerenciar a vitrine.</div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <input id="adm-email" placeholder="seu@email">
        <button id="adm-send" class="btn primary">Enviar link</button>
      </div>
    </div>

    <!-- APP -->
    <div id="adm-app" class="hide">
      <div class="section-title" style="margin-top:10px">
        <h2 id="dealerInfo">Carregando…</h2>
        <div class="tabs">
          <button class="btn" data-tab="tDash">Dashboard</button>
          <button class="btn" data-tab="tCars">Veículos</button>
          <button class="btn" data-tab="tLeads">Leads</button>
          <button class="btn" data-tab="tCfg">Configurações</button>
        </div>
      </div>

      <!-- DASHBOARD -->
      <div id="tDash" class="stack">
        <div class="kpi">
          <div class="card"><div class="pad"><div class="muted">Veículos ativos</div><div id="kAct" class="price">–</div></div></div>
          <div class="card"><div class="pad"><div class="muted">Destaques</div><div id="kStar" class="price">–</div></div></div>
          <div class="card"><div class="pad"><div class="muted">Leads (30d)</div><div id="kLead" class="price">–</div></div></div>
        </div>
      </div>

      <!-- VEÍCULOS -->
      <div id="tCars" class="stack hide">
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn primary" id="newCar">+ Novo veículo</button>
          <button class="btn" id="seed">Popular com 6 exemplos</button>
          <button class="btn" id="refreshCars">Atualizar</button>
        </div>

        <div class="table" id="carsTable">
          <div class="row head"><div>Título</div><div>Preço</div><div>Ano</div><div>KM</div><div>Status</div><div>Destaque</div><div>Ações</div></div>
          <!-- linhas via JS -->
        </div>
      </div>

      <!-- LEADS -->
      <div id="tLeads" class="stack hide">
        <div class="table" id="leadsTable">
          <div class="row head" style="grid-template-columns:1fr .9fr .7fr 2fr"><div>Quando</div><div>Canal</div><div>Veículo</div><div>Mensagem</div></div>
        </div>
      </div>

      <!-- CONFIG -->
      <div id="tCfg" class="stack hide">
        <div class="card pad" style="display:grid;gap:10px;max-width:560px">
          <label>Nome da vitrine <input id="cfgName"></label>
          <label>Cidade/UF <input id="cfgCity"></label>
          <label>WhatsApp (55+DDD+número) <input id="cfgWa"></label>
          <label>Cor da marca <input id="cfgColor" type="color" value="#25D366"></label>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="cfgSave" class="btn primary">Salvar</button>
            <span class="muted" style="font-size:12px">A cor atualiza o botão WA e destaques</span>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer class="wrap">© <span id="y"></span> — Vitrine conectada ao Supabase. Dados e imagens meramente ilustrativos.</footer>

<!-- WhatsApp flutuante -->
<a id="wa" class="wa" href="#" target="_blank" rel="noreferrer" aria-label="WhatsApp">WA</a>

<!-- Overlay fotos -->
<div class="over" id="over">
  <div class="panel">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3>Fotos do veículo</h3>
      <div style="display:flex;gap:8px">
        <button class="btn" id="btnUpFoto">+ Upload</button>
        <button class="btn primary" id="btnSaveOrder">Salvar ordem</button>
        <button class="btn ghost" id="btnCloseOver">Fechar</button>
      </div>
    </div>
    <div class="photo-grid" id="pg"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===================== CONFIG ===================== */
const SUPABASE_URL  = "https://ikrzslkihibraaalenxp.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrcnpzbGtpaGlicmFhYWxlbnhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNjc5MjUsImV4cCI6MjA3Nzk0MzkyNX0.VqAiCdgDs66opqYZjOPZPAdcN1Nee1kMczbrOYo4ip4";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true, detectSessionInUrl:true, autoRefreshToken:true }});

const DEALER_DEFAULT = { name:"Marcelo Macedo – Seminovos", city:"Belém/PA", whatsapp:"5591XXXXXXXXX", brand_color:"#25D366" };
const WA = (digits, t="Olá! Tenho interesse no veículo.") => "https://wa.me/"+digits+"?text="+encodeURIComponent(t);
const $ = (s,c=document)=>c.querySelector(s);
const BRL = n => (Number(n)||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const digits = s => String(s||"").replace(/\D/g,"");
const show = id => { ["page-estoque","page-detalhe","page-admin"].forEach(x=>$("#"+x).classList.add("hide")); $("#"+id).classList.remove("hide"); };
const on = (el,ev,fn)=>el&&el.addEventListener(ev,fn);

/* ===================== MENU & INIT ===================== */
on($("#menuBtn"),"click",()=>$("#menu").classList.toggle("open"));
document.getElementById("y").textContent = new Date().getFullYear();
let dealerId=null, dealer=null, dealerPhone=digits(DEALER_DEFAULT.whatsapp)||"5591XXXXXXXXX";
function applyBrand(color){ document.documentElement.style.setProperty('--brand', color||DEALER_DEFAULT.brand_color); }
function setWA(phone){ const d=digits(phone); dealerPhone = d.length>=11?d:"5591XXXXXXXXX"; $("#wa").href = WA(dealerPhone); }

show("page-estoque");

/* ===================== CATALOGO (público) ===================== */
const DEMO = [
  { id:"d1", title:"Volkswagen Polo 1.0", year:2024, km:45806, gearbox:"Manual", fuel:"Flex", price:72990, bairro:"Belém", destaque:true,  photos:["https://placehold.co/960x640/222/FFF?text=VW+Polo"] },
  { id:"d2", title:"Jeep Renegade Longitude 1.3", year:2024, km:45500, gearbox:"Automático", fuel:"Flex", price:111990, bairro:"Belém", destaque:true,  photos:["https://placehold.co/960x640/222/FFF?text=Jeep+Renegade"] },
  { id:"d3", title:"Nissan Kicks Advance 1.6", year:2024, km:40120, gearbox:"Automático", fuel:"Flex", price:108990, bairro:"Belém", destaque:true,  photos:["https://placehold.co/960x640/222/FFF?text=Nissan+Kicks"] },
  { id:"d4", title:"Fiat Cronos Drive 1.0", year:2024, km:46698, gearbox:"Manual", fuel:"Flex", price:75990, bairro:"Ananindeua", destaque:false, photos:["https://placehold.co/960x640/222/FFF?text=Fiat+Cronos"] },
  { id:"d5", title:"Chevrolet Onix LT 1.0", year:2024, km:44768, gearbox:"Manual", fuel:"Flex", price:69990, bairro:"Belém", destaque:false, photos:["https://placehold.co/960x640/222/FFF?text=Onix+LT"] },
  { id:"d6", title:"Hyundai HB20 Sense 1.0", year:2024, km:41104, gearbox:"Manual", fuel:"Flex", price:67990, bairro:"Ananindeua", destaque:false, photos:["https://placehold.co/960x640/222/FFF?text=HB20"] },
];
let cache=[];

async function fetchVehicles(){
  const { data, error } = await sb.from("vehicle_public").select("*").order("destaque",{ascending:false}).order("created_at",{ascending:false});
  cache = (!error && data && data.length)? data : DEMO;
  renderFeatured(); renderCatalog(); $("#count").textContent=cache.length;
}
function card(v){
  const foto=(v.photos&&v.photos[0])||"https://placehold.co/800x500?text=Sem+foto";
  const km=(v.km!=null)? v.km.toLocaleString("pt-BR")+" km":"";
  const meta=[v.year,km,v.gearbox,v.fuel].filter(Boolean).join(" • ");
  return `<article class="card">
    <a href="#/carro/${v.id}" onclick="return navDetalhe('${v.id}')"><div class="thumb"><img src="${foto}" alt=""></div></a>
    <div class="pad"><div class="title">${v.title||""}</div><div class="meta">${meta}</div><div class="price">${BRL(v.price)}</div>
      <div style="display:flex;gap:8px"><a class="btn primary" href="#" onclick="return interesse('${v.id}')">Proposta rápida</a><a class="btn" href="#/carro/${v.id}" onclick="return navDetalhe('${v.id}')">Detalhes</a></div>
    </div></article>`;
}
function renderFeatured(){ $("#featured").innerHTML = cache.filter(v=>v.destaque).map(card).join("")||"<div class='muted'>Sem destaques.</div>"; }
function renderCatalog(){
  const q=$("#q").value.trim().toLowerCase(), fy=$("#fy").value, ff=$("#ff").value, fg=$("#fg").value, fs=$("#fs").value;
  let list=cache.filter(v=>(!q||(v.title||'').toLowerCase().includes(q))&&(!fy||v.year>=+fy)&&(!ff||v.fuel===ff)&&(!fg||v.gearbox===fg));
  switch(fs){case"price-asc":list.sort((a,b)=>(a.price||0)-(b.price||0));break;case"price-desc":list.sort((a,b)=>(b.price||0)-(a.price||0));break;case"km-asc":list.sort((a,b)=>(a.km||0)-(b.km||0));break;default:list.sort((a,b)=>(b.year||0)-(a.year||0));}
  $("#list").innerHTML = list.map(card).join("")||"<p>Nenhum veículo encontrado.</p>";
}
window.addEventListener("hashchange",()=>{ const h=location.hash.split("/"); if(h[1]==="carro"&&h[2]) navDetalhe(h[2]); else if(h[1]==="admin") route("admin"); else route("estoque"); });

function navDetalhe(id){
  const v=cache.find(x=>x.id==id); if(!v) return false; show("page-detalhe");
  const foto=(v.photos&&v.photos[0])||"https://placehold.co/1200x700?text=Sem+foto";
  $("#dt-foto").innerHTML=`<img src="${foto}" style="width:100%;height:100%;object-fit:cover">`;
  $("#dt-title").textContent=v.title||""; const km=(v.km!=null)? v.km.toLocaleString("pt-BR")+" km":"";
  $("#dt-meta").textContent=[v.year,km,v.gearbox,v.fuel].filter(Boolean).join(" • ");
  $("#dt-price").textContent=BRL(v.price);
  const e=$("#s-entrada"), m=$("#s-meses"), t=$("#s-taxa"), p=$("#s-parcela");
  const recalc=()=>{ const E=+e.value||0, M=+m.value||1, I=(+t.value||0)/100, PV=Math.max(0,(v.price||0)-E); const parcela=(I>0)? (PV*I)/(1-Math.pow(1+I,-M)):(PV/M); p.textContent=BRL(parcela); };
  [e,m,t].forEach(i=>i.oninput=recalc); recalc();
  $("#btnProposta").onclick=()=>interesse(v.id);
  return false;
}
async function interesse(id){
  const v=cache.find(x=>x.id==id); if(!v) return false;
  const km=(v.km!=null)? v.km.toLocaleString("pt-BR")+" km":"";
  const msg=`Olá! Tenho interesse no ${v.title} (${v.year}, ${km}) por ${BRL(v.price)}.`;
  try{ await sb.from("lead").insert({ vehicle_id:id, channel:"interest", utm_source:"site", utm_medium:"proposta", utm_campaign:"catalog", message: msg }); }catch(e){}
  location.href = WA(dealerPhone, msg); return false;
}
["#q","#fy","#ff","#fg","#fs"].forEach(s=>on($(s),"input",()=>renderCatalog()));
sb.channel("rt").on("postgres_changes",{event:"*",schema:"public",table:"vehicle"},fetchVehicles).subscribe();

/* ===================== ADMIN (privado) ===================== */
const tabs=["tDash","tCars","tLeads","tCfg"];
function openTab(id){ tabs.forEach(t=>$("#"+t).classList.toggle("hide",t!==id)); }

on($("#adm-send"),"click",async()=>{
  const email=$("#adm-email").value.trim(); if(!email) return alert("Informe seu e-mail.");
  const redirect=location.origin + "/#/admin";
  const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: redirect }});
  if(error) alert(error.message); else alert("Link enviado. Abra seu e-mail e clique no link para entrar.");
});
on($("#btnLogout"),"click",async()=>{ await sb.auth.signOut(); alert("Sessão encerrada."); route("estoque"); });

async function route(page){
  $("#menu").classList.remove("open");
  if(page==="admin"){
    show("page-admin");
    const session = (await sb.auth.getSession()).data.session;
    if(!session){ $("#adm-login").classList.remove("hide"); $("#adm-app").classList.add("hide"); return false; }
    await ensureDealer(session.user); $("#adm-login").classList.add("hide"); $("#adm-app").classList.remove("hide"); openTab("tDash"); renderAdmin(); return false;
  } else {
    show("page-estoque"); fetchVehicles(); return false;
  }
}
(async()=>{ // tratar retorno do link mágico
  const hasAuth=/[?#].*(code|token_hash)=/i.test(location.href);
  if(hasAuth){ try{ await sb.auth.exchangeCodeForSession(location.href); }catch(e){ console.warn(e?.message||e); }
    history.replaceState({}, "", location.origin + location.pathname + "#/admin");
  }
  const { data } = await sb.auth.getSession();
  if(data?.session) { await ensureDealer(data.session.user); }
  fetchVehicles();
})();

async function ensureDealer(user){
  // Checa membro; se não existir, cria dealer padrão (owner)
  let { data: mem } = await sb.from("dealer_member").select("dealer_id,role").eq("user_id",user.id).maybeSingle();
  if(!mem){
    const ins = await sb.from("dealer").insert({ name: DEALER_DEFAULT.name, city: DEALER_DEFAULT.city, whatsapp: DEALER_DEFAULT.whatsapp, brand_color: DEALER_DEFAULT.brand_color, created_by:user.id }).select("id,whatsapp,brand_color,name,city").single();
    if(ins.error){ alert("Erro criando vitrine: "+ins.error.message); return; }
    await sb.from("dealer_member").insert({ dealer_id: ins.data.id, user_id:user.id, role:"owner" });
    mem = { dealer_id: ins.data.id, role:"owner" };
    dealer = ins.data;
  }
  dealerId = mem.dealer_id;
  if(!dealer){
    const dd = await sb.from("dealer").select("*").eq("id",dealerId).single();
    dealer = dd.data;
  }
  // aplica branding
  applyBrand(dealer.brand_color||DEALER_DEFAULT.brand_color);
  setWA(dealer.whatsapp||DEALER_DEFAULT.whatsapp);
  $("#dealerInfo").textContent = `${dealer.name||DEALER_DEFAULT.name} • ${(dealer.city||"")} • WhatsApp: ${dealer.whatsapp||""}`;
  // bloqueia admin para não-owner (UI — RLS deve proteger no banco)
  const role = mem.role||"seller";
  if(role!=="owner"){ $("#adm-app").innerHTML = `<div class="card pad">Sem permissão para administrar esta vitrine.</div>`; }
}

/* ========= Admin: dados ========= */
async function renderAdmin(){
  // KPIs
  const { data: kc } = await sb.from("vehicle").select("status,destaque").eq("dealer_id", dealerId);
  $("#kAct").textContent = (kc||[]).filter(v=>v.status==="ativo").length;
  $("#kStar").textContent = (kc||[]).filter(v=>v.destaque).length;
  const d30 = new Date(); d30.setDate(d30.getDate()-30);
  const { data: kl } = await sb.from("lead").select("id").gte("created_at", d30.toISOString());
  $("#kLead").textContent = (kl||[]).length;

  // Veículos
  await loadCars();
  // Leads
  await loadLeads();
  // Config
  $("#cfgName").value = dealer.name||""; $("#cfgCity").value = dealer.city||""; $("#cfgWa").value = dealer.whatsapp||""; $("#cfgColor").value = dealer.brand_color||DEALER_DEFAULT.brand_color;
  openTab("tDash");
}

/* ========= Veículos (CRUD) ========= */
on($("#newCar"),"click",async()=>{
  const title=prompt("Título (ex.: Polo 1.0 2024)"); if(!title) return;
  const price=+prompt("Preço (números)")||0, year=+prompt("Ano")||2024, km=+prompt("KM")||0;
  const gearbox=prompt("Câmbio (Automático/Manual)","Manual")||"Manual";
  const fuel=prompt("Combustível (Flex/Gasolina/Diesel/Híbrido/Elétrico)","Flex")||"Flex";
  const bairro=prompt("Bairro","Belém")||"Belém";
  const { error } = await sb.from("vehicle").insert({ dealer_id: dealerId, title, price, year, km, gearbox, fuel, bairro, status:"ativo" });
  if(error) alert(error.message); else loadCars();
});
on($("#seed"),"click",async()=>{
  if(!confirm("Inserir 6 veículos de exemplo?")) return;
  const payload = DEMO.map(v=>({ dealer_id:dealerId, title:v.title, year:v.year, km:v.km, gearbox:v.gearbox, fuel:v.fuel, price:v.price, bairro:v.bairro, status:"ativo", destaque:!!v.destaque }));
  const { error } = await sb.from("vehicle").insert(payload);
  if(error) alert(error.message); else loadCars();
});
on($("#refreshCars"),"click",()=>loadCars());

async function loadCars(){
  const { data } = await sb.from("vehicle").select("id,title,price,year,km,status,destaque").eq("dealer_id",dealerId).order("updated_at",{ascending:false});
  const wrap = document.createElement("div");
  (data||[]).forEach(v=>{
    const row=document.createElement("div"); row.className="row";
    row.innerHTML = `
      <div><strong>${v.title}</strong></div>
      <div>${BRL(v.price)}</div>
      <div>${v.year||""}</div>
      <div>${(v.km||0).toLocaleString('pt-BR')} km</div>
      <div>${v.status}</div>
      <div>${v.destaque? "⭐":"—"}</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn" data-act="foto" data-id="${v.id}">Fotos</button>
        <button class="btn" data-act="edit" data-id="${v.id}">Editar</button>
        <button class="btn" data-act="tog"  data-id="${v.id}">${v.status==='ativo'?'Pausar':'Ativar'}</button>
        <button class="btn" data-act="star" data-id="${v.id}">${v.destaque?'Remover destaque':'Destacar'}</button>
        <button class="btn warn" data-act="del" data-id="${v.id}">Excluir</button>
      </div>`;
    wrap.appendChild(row);
  });
  const table=$("#carsTable"); table.querySelectorAll(".row:not(.head)").forEach(e=>e.remove());
  table.appendChild(wrap);

  table.querySelectorAll("button[data-act]").forEach(b=>{
    b.onclick = async ()=>{
      const id=b.dataset.id, act=b.dataset.act;
      if(act==="tog"){ const { data:v } = await sb.from("vehicle").select("status").eq("id",id).single(); await sb.from("vehicle").update({ status:(v.status==='ativo'?'pausado':'ativo')}).eq("id",id); loadCars(); }
      if(act==="star"){ const { data:v } = await sb.from("vehicle").select("destaque").eq("id",id).single(); await sb.from("vehicle").update({ destaque:!v.destaque}).eq("id",id); loadCars(); fetchVehicles(); }
      if(act==="edit"){ const { data:v } = await sb.from("vehicle").select("*").eq("id",id).single();
        const title=prompt("Título", v.title); if(!title&&title!=="") return;
        const price=+prompt("Preço", v.price); const year=+prompt("Ano",v.year); const km=+prompt("KM",v.km);
        await sb.from("vehicle").update({ title,price,year,km }).eq("id",id); loadCars();
      }
      if(act==="del"){ if(confirm("Excluir este veículo?")){ await sb.from("vehicle").delete().eq("id",id); loadCars(); fetchVehicles(); } }
      if(act==="foto"){ openPhotos(id); }
    };
  });
}

/* ========= Fotos: upload, substituir, remover, ordenar ========= */
let currentVehicleId=null, photos=[];
function openPhotos(id){
  currentVehicleId=id; $("#over").classList.add("open"); loadPhotos();
}
on($("#btnCloseOver"),"click",()=>$("#over").classList.remove("open"));
on($("#btnUpFoto"),"click",()=>{ const i=Object.assign(document.createElement("input"),{type:"file",accept:"image/*"}); i.onchange=upPhoto; i.click(); });
async function upPhoto(ev){
  const f=ev.target.files[0]; if(!f) return;
  const path = dealerId + "/" + currentVehicleId + "/" + Date.now() + "-" + f.name;
  const up = await sb.storage.from("car-photos").upload(path, f, { cacheControl:"3600", upsert:false });
  if(up.error) return alert(up.error.message);
  const url = sb.storage.from("car-photos").getPublicUrl(path).data.publicUrl;
  const idx = photos.length;
  await sb.from("vehicle_photo").insert({ vehicle_id:currentVehicleId, url, idx });
  loadPhotos();
}
async function loadPhotos(){
  const r = await sb.from("vehicle_photo").select("id,url,idx").eq("vehicle_id",currentVehicleId).order("idx");
  photos = r.data||[];
  const pg=$("#pg"); pg.innerHTML="";
  if(!photos.length) pg.innerHTML = "<div class='muted'>Sem fotos. Faça upload acima.</div>";
  photos.forEach((p,i)=>{
    const el=document.createElement("div"); el.className="ph"; el.draggable=true; el.dataset.index=i;
    el.innerHTML=`<img src="${p.url}"><div class="tag">${i===0?"Capa":"Foto "+(i+1)}</div>
      <div class="bar">
        <button class="btn" data-rp="${i}">Substituir</button>
        <button class="btn warn" data-rm="${i}">Remover</button>
        <button class="btn" data-top="${i}">Tornar capa</button>
      </div>`;
    // drag
    el.addEventListener("dragstart",e=>{e.dataTransfer.setData("text/plain",i);});
    el.addEventListener("dragover",e=>e.preventDefault());
    el.addEventListener("drop",e=>{ e.preventDefault(); const from=+e.dataTransfer.getData("text/plain"); const to=+el.dataset.index; if(from===to) return; const it=photos.splice(from,1)[0]; photos.splice(to,0,it); renderTempOrder(); });
    pg.appendChild(el);
  });
  wirePhotoButtons();
}
function renderTempOrder(){ // re-render grid with new order (preview)
  const pg=$("#pg"); pg.querySelectorAll(".ph").forEach((el,i)=>{ el.dataset.index=i; el.querySelector(".tag").textContent = i===0?"Capa":"Foto "+(i+1); });
}
function wirePhotoButtons(){
  $("#pg").querySelectorAll("[data-rm]").forEach(b=>b.onclick=async()=>{ const i=+b.dataset.rm; const p=photos[i]; await sb.from("vehicle_photo").delete().eq("id",p.id); loadPhotos(); });
  $("#pg").querySelectorAll("[data-top]").forEach(b=>b.onclick=()=>{ const i=+b.dataset.top; const it=photos.splice(i,1)[0]; photos.unshift(it); renderTempOrder(); });
  $("#pg").querySelectorAll("[data-rp]").forEach(b=>b.onclick=()=>{ const i=+b.dataset.rp; const input=Object.assign(document.createElement("input"),{type:"file",accept:"image/*"}); input.onchange=async(e)=>{ const f=e.target.files[0]; if(!f) return; const path = dealerId + "/" + currentVehicleId + "/" + Date.now() + "-" + f.name; const up=await sb.storage.from("car-photos").upload(path,f,{cacheControl:"3600",upsert:false}); if(up.error) return alert(up.error.message); const url = sb.storage.from("car-photos").getPublicUrl(path).data.publicUrl; await sb.from("vehicle_photo").update({ url }).eq("id", photos[i].id); loadPhotos(); }; input.click(); });
}
on($("#btnSaveOrder"),"click",async()=>{
  await Promise.all(photos.map((p,idx)=> sb.from("vehicle_photo").update({ idx }).eq("id",p.id) ));
  alert("Ordem salva!"); loadPhotos(); fetchVehicles();
});

/* ========= Leads ========= */
async function loadLeads(){
  const { data } = await sb.rpc ? {} : await sb.from("lead_view").select("*"); // se existir view
  let leads;
  if(data){ leads=data; }
  else{
    const { data: raw } = await sb.from("lead").select("created_at,channel,vehicle_id,message").order("created_at",{ascending:false}).limit(100);
    const ids=[...new Set((raw||[]).map(l=>l.vehicle_id))];
    let names={}; if(ids.length){ const r=await sb.from("vehicle").select("id,title").in("id",ids); (r.data||[]).forEach(v=>names[v.id]=v.title); }
    leads=(raw||[]).map(l=>({ when:new Date(l.created_at).toLocaleString("pt-BR"), channel:l.channel, vehicle:names[l.vehicle_id]||l.vehicle_id, message:l.message }));
  }
  const tbl=$("#leadsTable"); tbl.querySelectorAll(".row:not(.head)").forEach(e=>e.remove());
  (leads||[]).forEach(L=>{
    const r=document.createElement("div"); r.className="row"; r.style.gridTemplateColumns="1fr .9fr .7fr 2fr";
    r.innerHTML=`<div>${L.when||new Date(L.created_at).toLocaleString("pt-BR")}</div><div>${L.channel||"-"}</div><div>${L.vehicle||"-"}</div><div>${L.message||"-"}</div>`;
    tbl.appendChild(r);
  });
}

/* ========= Config ========= */
on($("#cfgSave"),"click",async()=>{
  const name=$("#cfgName").value.trim(), city=$("#cfgCity").value.trim(), whatsapp=$("#cfgWa").value.trim(), brand_color=$("#cfgColor").value;
  const { error } = await sb.from("dealer").update({ name, city, whatsapp, brand_color }).eq("id",dealerId);
  if(error) alert(error.message); else { dealer={...dealer,name,city,whatsapp,brand_color}; applyBrand(brand_color); setWA(whatsapp); alert("Salvo!"); $("#dealerInfo").textContent = `${dealer.name} • ${dealer.city} • WhatsApp: ${dealer.whatsapp}`; }
});

/* ========= Navegação das abas ========= */
document.querySelectorAll(".tabs .btn").forEach(b=> b.addEventListener("click", ()=> openTab(b.dataset.tab)) );

/* ========= Subscriptions ========= */
sb.channel("adm_rt").on("postgres_changes",{event:"*",schema:"public",table:"vehicle_photo"},loadPhotos).subscribe();

/* ========= Rota inicial ========= */
function openAdminUI(){ show("page-admin"); $("#adm-login").classList.add("hide"); $("#adm-app").classList.remove("hide"); }
</script>
</body>
</html>
